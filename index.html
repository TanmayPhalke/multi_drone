<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Drone GCS Dashboard</title>
  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { padding: 0.5em; border-bottom: 1px solid #ccc; }
    button { padding: 6px 12px; }
    .armed { color: red; font-weight: bold; }
    .disarmed { color: green; font-weight: bold; }
    #map { height: 400px; margin-top: 2em; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>üöÅ Multi-Drone GCS Dashboard</h1>

  <table>
    <thead>
      <tr>
        <th>Drone ID</th><th>IP</th><th>Port</th>
        <th>Battery</th><th>Altitude</th><th>Status</th><th>Action</th>
      </tr>
    </thead>
    <tbody id="drone-list"></tbody>
  </table>

  <div id="map"></div>

  <script>
    const socket = io();
    let droneData = {};
    let markers = {};
    const map = L.map('map').setView([20, 78], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    function refreshDrones() {
      socket.emit('get_drones');
    }

    function launchMP(droneId) {
      socket.emit('launch_mp', { drone_id: droneId });
    }

    function toggleArm(droneId) {
      socket.emit('toggle_arm', { drone_id: droneId });
    }

    function updateMap(id, lat, lon) {
      if (markers[id]) {
        markers[id].setLatLng([lat, lon]);
      } else {
        markers[id] = L.marker([lat, lon]).addTo(map).bindPopup(id);
      }
    }

    function renderDrones() {
      const tbody = document.getElementById('drone-list');
      tbody.innerHTML = '';
      Object.entries(droneData).forEach(([id, info]) => {
        const row = document.createElement('tr');
        const armStatus = info.armed ? 'ARMED' : 'DISARMED';
        const armClass = info.armed ? 'armed' : 'disarmed';
        row.innerHTML = `
          <td>${id}</td>
          <td>${info.ip}</td>
          <td>${info.port}</td>
          <td>${(info.battery || 0).toFixed(1)}%</td>
          <td>${(info.altitude || 0).toFixed(1)} m</td>
          <td class="${armClass}">${armStatus}</td>
          <td>
            <button onclick="launchMP('${id}')">Launch MP</button>
            <button onclick="toggleArm('${id}')">Toggle Arm</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    socket.on('drones', (drones) => {
      droneData = drones;
      renderDrones();
    });

    socket.on('telemetry', data => {
      const drone = droneData[data.drone_id];
      if (drone) {
        Object.assign(drone, data);
        renderDrones();
        updateMap(data.drone_id, data.lat, data.lon);
      }
    });

    socket.on('status_update', data => {
      if (droneData[data.drone_id]) {
        droneData[data.drone_id].armed = data.armed;
        renderDrones();
      }
    });

    socket.on('mp_launched', data => {
      alert(`Mission Planner launched for ${data.drone_id}`);
    });

    socket.on('error', e => {
      alert('Error: ' + e.message);
    });

    refreshDrones();
    setInterval(refreshDrones, 5000);
    socket.emit('start_telemetry');
  </script>
</body>
</html>
